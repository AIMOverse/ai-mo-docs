# Coinbase AgentKit + AiMo Integration

Connect Coinbase AgentKit to AiMo Network to power your Base/multi-chain agents with decentralized LLM inference and routing.

This guide shows you how to integrate AiMo as the LLM provider for an existing or new Coinbase AgentKit project.

---

## Why AiMo + Coinbase AgentKit?

- **Decentralized inference**: Route LLM requests through AiMo's network instead of centralized providers
- **Cost optimization**: Competitive pricing with automatic provider selection
- **Model flexibility**: Access multiple models (Claude, GPT, Kimi, etc.) through a single interface
- **Multi-chain support**: Combine AiMo's reasoning with AgentKit's Base, Ethereum, and other EVM chains

---

## Prerequisites

- Existing Coinbase AgentKit project (or scaffold with `pnpm create onchain-agent@latest`)
- AiMo API key ([get one here](https://aimo.network))
- Coinbase Developer Platform (CDP) API credentials
- Node.js 18+

---

## 1. Add AiMo Environment Variables

Add these to your `.env` file:

```bash
# AiMo Network Configuration
AIMO_API_KEY=your_aimo_api_key_here
AIMO_BASE_URL=https://devnet.aimo.network/api/v1
AIMO_MODEL=kimi-k2-0711-preview

# Your existing Coinbase AgentKit variables
CDP_API_KEY=your_cdp_key
CDP_API_SECRET=your_cdp_secret
COINBASE_WALLET_SECRET=your_wallet_secret
WALLET_ADDRESS=0xYourWalletAddress
# ... other agent kit vars
```

Available models on AiMo:
- `kimi-k2-0711-preview` (recommended for agents)
- `claude-3-5-sonnet-20241022`
- `gpt-4o-mini`
- `gpt-4o`

Update `.env.example` (without real secrets):

```bash
AIMO_API_KEY=
AIMO_BASE_URL=https://devnet.aimo.network/api/v1
AIMO_MODEL=kimi-k2-0711-preview
CDP_API_KEY=
CDP_API_SECRET=
COINBASE_WALLET_SECRET=
WALLET_ADDRESS=
```

---

## 2. Create the AiMo LLM Client

Create `src/llm/createLLMClient.ts`:

```typescript
interface AimoMessage {
  role: 'system' | 'user' | 'assistant' | 'tool';
  content: string;
  name?: string;
}

export function createLLMClient(config: {
  aimoKey?: string;
  aimoBaseUrl?: string;
  aimoModel?: string;
  openaiKey?: string;
  anthropicKey?: string;
  defaultProvider?: 'aimo' | 'openai' | 'anthropic';
}) {
  const provider = config.defaultProvider || 'aimo';

  if (provider === 'aimo') {
    if (!config.aimoKey || !config.aimoBaseUrl || !config.aimoModel) {
      throw new Error('AiMo configuration requires: aimoKey, aimoBaseUrl, aimoModel');
    }

    return {
      async chat(messages: AimoMessage[], options?: {
        temperature?: number;
        maxTokens?: number;
      }) {
        const response = await fetch(`${config.aimoBaseUrl}/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${config.aimoKey}`,
          },
          body: JSON.stringify({
            model: config.aimoModel,
            messages,
            temperature: options?.temperature ?? 0.4,
            max_tokens: options?.maxTokens,
          }),
        });

        if (!response.ok) {
          const error = await response.text();
          throw new Error(`AiMo API error (${response.status}): ${error}`);
        }

        const data = await response.json();
        return data.choices?.[0]?.message?.content || '';
      },

      async chatStream(messages: AimoMessage[], options?: {
        temperature?: number;
        maxTokens?: number;
      }) {
        const response = await fetch(`${config.aimoBaseUrl}/chat/completions`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${config.aimoKey}`,
          },
          body: JSON.stringify({
            model: config.aimoModel,
            messages,
            temperature: options?.temperature ?? 0.4,
            max_tokens: options?.maxTokens,
            stream: true,
          }),
        });

        if (!response.ok) {
          throw new Error(`AiMo API error: ${response.status}`);
        }

        return response.body;
      }
    };
  }

  // Fallback to other providers if needed
  throw new Error(`Provider ${provider} not implemented in this example`);
}
```

---

## 3. Integrate AiMo into AgentKit Initialization

Update your agent creation (e.g., `src/agent/createAgent.ts`):

```typescript
import { config } from 'dotenv';
config();

import { AgentRuntime } from '@coinbase/agentkit'; // Adjust import per actual AgentKit API
import { createLLMClient } from '../llm/createLLMClient';
import { buildTools } from '../tools/buildTools';

function loadEnvOrThrow(name: string): string {
  const value = process.env[name];
  if (!value) {
    throw new Error(`Missing required environment variable: ${name}`);
  }
  return value;
}

export async function createAgent() {
  // Initialize AiMo LLM client
  const llmClient = createLLMClient({
    aimoKey: loadEnvOrThrow('AIMO_API_KEY'),
    aimoBaseUrl: loadEnvOrThrow('AIMO_BASE_URL'),
    aimoModel: loadEnvOrThrow('AIMO_MODEL'),
    defaultProvider: 'aimo',
  });

  // Initialize AgentKit with AiMo as the LLM provider
  // Note: Actual API depends on AgentKit version - adapt as needed
  const agent = await AgentRuntime.initialize({
    walletSecret: loadEnvOrThrow('COINBASE_WALLET_SECRET'),
    walletAddress: loadEnvOrThrow('WALLET_ADDRESS'),
    cdp: {
      apiKey: loadEnvOrThrow('CDP_API_KEY'),
      apiSecret: loadEnvOrThrow('CDP_API_SECRET'),
      projectId: process.env.CDP_PROJECT_ID,
    },
    llm: llmClient, // Pass AiMo client here
    tools: buildTools(),
    options: {
      maxToolCalls: 8,
      temperature: 0.4,
    },
  });

  return { agent, llmClient };
}
```

---

## 4. Create Your Agent Entrypoint

Example `src/index.ts`:

```typescript
import { createAgent } from './agent/createAgent';

async function main() {
  const { agent, llmClient } = await createAgent();

  const userPrompt = process.argv.slice(2).join(' ') || 'What is my wallet address?';
  
  console.log('User:', userPrompt);
  console.log('Agent thinking...\n');

  // If AgentKit supports streaming:
  try {
    const stream = await agent.respond({
      input: userPrompt,
      metadata: { source: 'cli' }
    });

    for await (const chunk of stream) {
      process.stdout.write(chunk.content ?? '');
    }
    console.log('\n');
  } catch (err) {
    console.error('Agent error:', err);
    process.exit(1);
  }
}

main().catch(err => {
  console.error('Fatal error:', err);
  process.exit(1);
});
```

---

## 5. Add Basic Tools (Example)

Create `src/tools/buildTools.ts`:

```typescript
export function buildTools() {
  return [
    {
      name: 'get_wallet_address',
      description: 'Returns the configured wallet address',
      run: async ({ context }: any) => {
        return {
          address: context.walletAddress,
          network: 'Base',
        };
      }
    },
    {
      name: 'get_balance',
      description: 'Gets ETH balance for the wallet',
      run: async ({ context }: any) => {
        // Implement using AgentKit's CDP utilities
        // const balance = await context.cdp.getBalance(...);
        return {
          balance: '0.1 ETH', // Placeholder
          address: context.walletAddress,
        };
      }
    },
    // Add more tools: transfer, swap, deploy contract, etc.
  ];
}
```

---

## 6. Install Dependencies

```bash
pnpm install
```

---

## 7. Run Your Agent

```bash
# Development
pnpm dev "What is my wallet address?"

# Or if you need to build first
pnpm build && pnpm start "What is my wallet address?"
```

---

## 8. Test AiMo Integration

Verify AiMo is handling requests:

```typescript
// test-aimo.ts
import { config } from 'dotenv';
config();

import { createLLMClient } from './src/llm/createLLMClient';

async function test() {
  const client = createLLMClient({
    aimoKey: process.env.AIMO_API_KEY!,
    aimoBaseUrl: process.env.AIMO_BASE_URL!,
    aimoModel: process.env.AIMO_MODEL!,
    defaultProvider: 'aimo',
  });

  const response = await client.chat([
    {
      role: 'user',
      content: 'Respond with "AiMo + AgentKit integration working" if you can read this.'
    }
  ]);

  console.log('Response:', response);
}

test().catch(console.error);
```

Run:
```bash
npx ts-node test-aimo.ts
```

---

## 9. Troubleshooting

| Issue | Solution |
|-------|----------|
| `Missing required environment variable: AIMO_API_KEY` | Add `AIMO_API_KEY` to `.env` and restart |
| `401 Unauthorized` from AiMo | Verify API key is correct |
| `Model not found` | Check `AIMO_MODEL` matches available models (see section 1) |
| `401 Unauthorized` from CDP | Check `CDP_API_KEY` and `CDP_API_SECRET` |
| Wallet signing failure | Verify `COINBASE_WALLET_SECRET` format (hex string, no whitespace) |
| Tool not found | Confirm `buildTools()` exports the tool |

---

## Example: Complete Agent with AiMo + AgentKit

Minimal working example:

```typescript
// minimal-agent.ts
import { config } from 'dotenv';
config();

import { createLLMClient } from './src/llm/createLLMClient';

const llm = createLLMClient({
  aimoKey: process.env.AIMO_API_KEY!,
  aimoBaseUrl: process.env.AIMO_BASE_URL!,
  aimoModel: process.env.AIMO_MODEL!,
  defaultProvider: 'aimo',
});

async function simpleAgent(prompt: string) {
  const response = await llm.chat([
    {
      role: 'system',
      content: 'You are a helpful Base blockchain assistant. You can check balances and explain concepts.'
    },
    {
      role: 'user',
      content: prompt
    }
  ]);

  console.log('Agent:', response);
  return response;
}

// Test it
simpleAgent('Explain what Base is in one sentence.').catch(console.error);
```

---

## 10. Next Steps

- **Add blockchain tools**: Integrate AgentKit's full tool suite (transfers, swaps, contract calls)
- **Streaming responses**: Use `chatStream()` for real-time agent output
- **Multi-chain**: Expand beyond Base to Ethereum, Polygon, etc.
- **Cost tracking**: Monitor AiMo credit usage
- **Production deployment**: See [AiMo deployment docs](/deployment)

For full Coinbase AgentKit documentation, see:
- [Coinbase AgentKit GitHub](https://github.com/coinbase/agentkit)
- [CDP API Documentation](https://docs.cdp.coinbase.com/)
