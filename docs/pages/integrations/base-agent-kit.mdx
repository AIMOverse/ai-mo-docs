# Coinbase AgentKit Integration Guide

## Overview
This guide walks you through integrating Coinbase AgentKit into your on-chain agent application. You will:
1. Scaffold a new project.
2. Collect required API credentials.
3. Configure environment variables.
4. Instantiate an agent with AgentKit.
5. Run the development server.

## Prerequisites
- Node.js 18+ (recommended LTS)
- `pnpm` installed
- A Coinbase Developer Platform (CDP) account
- Access to create API keys and a Smart Wallet (or Wallet-as-a-Service credentials)
- An Aimo API key (if your platform uses Aimo for orchestration or LLM routing)

Optional:
- OpenAI / Anthropic / Other LLM provider keys (if you plan multi-provider routing)

## 1. Scaffold the Project

Run the official AgentKit initializer:

```
pnpm create onchain-agent@latest
```

Follow the interactive prompts (choose JavaScript/TypeScript depending on preference). After completion, `cd` into the generated directory.

## 2. Collect Required API Keys

You’ll need the following secrets before continuing:

| Key | Description | Where to Get It |
|-----|-------------|------------------|
| AIMO_API_KEY | Aimo platform key (if integrating orchestration) | Aimo dashboard |
| CDP_API_KEY | Coinbase Developer Platform key | CDP dashboard |
| CDP_API_SECRET | Secret corresponding to the CDP API key | Shown once at creation |
| CDP_PROJECT_ID (if applicable) | Some setups require explicit project id | CDP dashboard |
| COINBASE_WALLET_SECRET (or SMART_WALLET_PRIVATE_KEY) | Smart wallet signing secret / private key | Wallet setup flow |
| WALLET_ADDRESS | Associated public wallet address | Derived from wallet |
| Optional: OPENAI_API_KEY / ANTHROPIC_API_KEY | LLM providers | Their dashboards |

Security notes:
- Never commit secrets to git.
- Prefer `.env.local` and secret managers in production.
- Rotate keys regularly.

## 3. Project Structure (Example)

After scaffolding, you might have something like:

```
.
├─ src/
│  ├─ index.ts
│  ├─ agent/
│  │  └─ createAgent.ts
│  ├─ tools/
│  └─ config/
├─ package.json
├─ .env.example
├─ README.md
└─ pnpm-lock.yaml
```

If the scaffold didn’t create a dedicated `agent` folder, you can add one for clarity.

## 4. Configure Environment Variables

Create a `.env` (or `.env.local`) in the project root:

```
# Core platform + orchestration
AIMO_API_KEY=your_aimo_key_here

# Coinbase Developer Platform
CDP_API_KEY=your_cdp_key
CDP_API_SECRET=your_cdp_secret
CDP_PROJECT_ID=optional_if_required

# Smart Wallet / Signing
COINBASE_WALLET_SECRET=your_wallet_secret_or_private_key
WALLET_ADDRESS=0xYourWalletAddress

# Runtime config
NODE_ENV=development
LOG_LEVEL=debug
```

Add an `.env.example` (without real secrets) to help collaborators:

```
AIMO_API_KEY=
CDP_API_KEY=
CDP_API_SECRET=
CDP_PROJECT_ID=
COINBASE_WALLET_SECRET=
WALLET_ADDRESS=
OPENAI_API_KEY=
ANTHROPIC_API_KEY=
NODE_ENV=development
LOG_LEVEL=info
```

## 5. Create / Modify the Agent Initialization

Below is a conceptual example using AgentKit + a basic LLM wrapper. Adjust per the actual API surface of `@coinbase/agentkit` (names may differ slightly depending on version):

```
// src/agent/createAgent.ts
import { config } from 'dotenv';
config();

import { AgentRuntime } from '@coinbase/agentkit'; // Placeholder; use actual exported class/module
import { buildTools } from './tools/buildTools';  // Your custom tool registry
import { createLLMClient } from '../llm/createLLMClient'; // Abstraction over OpenAI/Anthropic/Aimo routing

interface AgentDependencies {
  llm: ReturnType<typeof createLLMClient>;
  tools: any[];
  wallet: {
    secret: string;
    address: string;
  };
  cdp: {
    apiKey: string;
    apiSecret: string;
    projectId?: string;
  };
}

function loadEnvOrThrow(name: string): string {
  const v = process.env[name];
  if (!v) {
    throw new Error(`Missing required environment variable: ${name}`);
  }
  return v;
}

export async function createAgent() {
  const deps: AgentDependencies = {
    llm: createLLMClient({
      openaiKey: process.env.OPENAI_API_KEY,
      anthropicKey: process.env.ANTHROPIC_API_KEY,
      aimoKey: process.env.AIMO_API_KEY,
      defaultProvider: 'openai',
      model: 'gpt-4o-mini'
    }),
    tools: buildTools(),
    wallet: {
      secret: loadEnvOrThrow('COINBASE_WALLET_SECRET'),
      address: loadEnvOrThrow('WALLET_ADDRESS'),
    },
    cdp: {
      apiKey: loadEnvOrThrow('CDP_API_KEY'),
      apiSecret: loadEnvOrThrow('CDP_API_SECRET'),
      projectId: process.env.CDP_PROJECT_ID,
    }
  };

  // Illustrative: Actual constructor/factory may differ
  const agent = await AgentRuntime.initialize({
    walletSecret: deps.wallet.secret,
    walletAddress: deps.wallet.address,
    cdp: {
      apiKey: deps.cdp.apiKey,
      apiSecret: deps.cdp.apiSecret,
      projectId: deps.cdp.projectId
    },
    llm: deps.llm,
    tools: deps.tools,
    // Optional: pass logging, tracing, caching adapters
    options: {
      maxToolCalls: 8,
      temperature: 0.4
    }
  });

  return agent;
}
```

If the real AgentKit exports differ, align the import names and constructor parameters accordingly (refer to the latest README/examples in the AgentKit repo).

Example `src/index.ts` (entrypoint):

```
import { createAgent } from './agent/createAgent';

async function main() {
  const agent = await createAgent();

  const userPrompt = process.argv.slice(2).join(' ') || 'Explain AgentKit basics.';
  const stream = await agent.respond({
    input: userPrompt,
    metadata: { source: 'cli' }
  });

  // If streaming:
  for await (const chunk of stream) {
    process.stdout.write(chunk.content ?? '');
  }

  // Or if single response:
  // const reply = await agent.respondOnce({ input: userPrompt });
  // console.log(reply.output);
}

main().catch(err => {
  console.error('Fatal error:', err);
  process.exit(1);
});
```

---

## 6. Install Dependencies

(If not already installed by the scaffold.)

```
pnpm install
```

---

## 7. Run in Development

```
pnpm dev
```

Common alternatives:
- `pnpm start` (if you compiled TypeScript first)
- `pnpm build && pnpm start`

---

## 8. Test an Interaction

Example CLI run:

```
pnpm dev "What is my wallet address?"
```

Expected behavior:
- Logs showing env load + agent initialization.
- Response referencing the wallet or on-chain context if tools are configured.

---

## 9. Adding Tools

Create a simple tool registry:

```
// src/tools/buildTools.ts
export function buildTools() {
  return [
    {
      name: 'get_wallet_address',
      description: 'Returns the configured wallet address',
      run: async ({ context }: any) => {
        return context.walletAddress;
      }
    },
    // Add blockchain read tool, token price tool, transfer tool, etc.
  ];
}
```

Integrate actual blockchain read/write operations via AgentKit utilities or CDP APIs.

---

## 10. Troubleshooting

| Issue | Likely Cause | Remedy |
|-------|--------------|--------|
| Missing required env var error | Not set in `.env` | Add + restart |
| Unauthorized (401) from CDP | Wrong API key/secret | Regenerate in CDP dashboard |
| Wallet signing failure | Invalid private key format | Ensure hex string w/o whitespace |
| Tool not found | Not exported / not in array | Confirm `buildTools()` returns it |
| Slow responses | LLM latency | Enable streaming / caching |

---

## 11. Security Best Practices
- Never log full secrets—mask them.
- Use secret managers (AWS Secrets Manager, Vault) in staging/production.
- Set strict IAM scopes on CDP keys.
- Consider rate limiting and circuit breakers for LLM calls.
- Add request tracing (e.g., OpenTelemetry) for observability.

---

## 12. Next Steps
- Add persistence (conversation memory store).
- Add more on-chain tools (transfer, balance check, swap).
- Integrate cost tracking per interaction.
- Implement evaluation harness for agent reliability.

---

## Quick Reference

```
# Scaffold
pnpm create onchain-agent@latest

# Configure environment
cp .env.example .env
# Fill in required keys

# Run dev
pnpm dev

# Example usage
pnpm dev "Summarize the latest transaction."
```

---

If you want this saved into your repo as a doc file, let me know the desired path (e.g., `ai-mo-docs/docs/agentkit-integration.md`) and I can add it. Just say the word. Would you like me to create this file now?
